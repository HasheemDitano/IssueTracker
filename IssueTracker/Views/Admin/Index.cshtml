@model List<(Microsoft.AspNetCore.Identity.IdentityUser User, System.Collections.Generic.IList<string> Roles)>

<style>
    .admin-card {
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .admin-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .admin-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 16px 16px 0 0;
    }
    
    .role-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .info-card {
        transition: transform 0.2s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
    }
    
    /* Simple button styles */
    .btn-sm:hover {
        opacity: 0.9;
    }
    
    /* Role dropdown styles */
    .form-select-sm {
        font-size: 0.875rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-select-sm:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    .form-select-sm:hover {
        border-color: #9ca3af;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<div class="d-flex justify-content-between align-items-start mb-5 fade-in-up">
    <div>
        <h1 class="mb-3 d-flex align-items-center">
            <i data-lucide="users-cog" class="me-3" style="width: 32px; height: 32px;"></i>User Management
        </h1>
        <p class="text-muted lead mb-0">Manage user roles and permissions</p>
    </div>
</div>

<div class="card admin-card fade-in-up" style="animation-delay: 0.2s; min-height: 600px; position: relative;">
<div class="card-header d-flex align-items-center" style="padding: 1.5rem;">
    <i data-lucide="users" class="me-3" style="width: 20px; height: 20px;"></i>
    <div>
        <h5 class="mb-0">System Users</h5>
        <small class="text-muted">Manage user roles and permissions (Visual Only)</small>
    </div>
</div>
<div class="card-body" style="padding: 2rem;">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
<thead>
    <tr>
        <th>
            <div class="d-flex align-items-center">
                <i data-lucide="mail" class="me-2" style="width: 14px; height: 14px;"></i>Email
            </div>
        </th>
        <th>
            <div class="d-flex align-items-center">
                <i data-lucide="user-check" class="me-2" style="width: 14px; height: 14px;"></i>Current Role
            </div>
        </th>
        <th>
            <div class="d-flex align-items-center">
                <i data-lucide="settings" class="me-2" style="width: 14px; height: 14px;"></i>Assign Role
            </div>
        </th>
        <th>
            <div class="d-flex align-items-center">
                <i data-lucide="settings" class="me-2" style="width: 14px; height: 14px;"></i>Actions
            </div>
        </th>
    </tr>
</thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="comment-avatar me-3">
                            <i data-lucide="user" style="width: 16px; height: 16px; color: var(--primary-500);"></i>
                        </div>
                        <div>
                            <div class="fw-semibold" style="color: var(--gray-900);">@item.User.Email</div>
                            <small class="text-muted">User ID: @item.User.Id.Substring(0, 8)...</small>
                        </div>
                    </div>
                </td>
                <td>
                    @{
                        var userRole = item.Roles.FirstOrDefault();
                    }
                    @if (!string.IsNullOrEmpty(userRole))
                    {
                        var roleClass = userRole switch
                        {
                            "Admin" => "bg-danger text-white",
                            "Engineer" => "bg-warning text-dark",
                            "Customer" => "bg-info text-white",
                            _ => "bg-secondary text-white"
                        };
                        <span class="role-badge @roleClass">
                            <i data-lucide="user-check" class="me-1" style="width: 12px; height: 12px;"></i>@userRole
                        </span>
                    }
                    else
                    {
                        <span class="text-muted">No role assigned</span>
                    }
                </td>
                <td>
                    @{
                        var currentUserRole = item.Roles.FirstOrDefault() ?? "";
                    }
                    <div class="d-flex align-items-center gap-2">
                        <select class="form-select form-select-sm" style="width: 140px;" onchange="updateRoleDisplay(this, '@item.User.Id')" data-user-id="@item.User.Id">
                            <option value="" selected="@(string.IsNullOrEmpty(currentUserRole))">No Role</option>
                            <option value="Customer" selected="@(currentUserRole == "Customer")">Customer</option>
                            <option value="Engineer" selected="@(currentUserRole == "Engineer")">Engineer</option>
                            <option value="Admin" selected="@(currentUserRole == "Admin")">Admin</option>
                        </select>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUser('@item.User.Id', '@item.User.Email')" title="Delete User">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
            </table>
        </div>
    </div>
    
    <!-- Additional Information Section -->
    <div class="mt-4 p-4" style="background: #f8fafc; border-radius: 12px; border-left: 4px solid #667eea;">
        <div class="row">
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-2">
                    <i data-lucide="info" class="me-2 text-primary" style="width: 16px; height: 16px;"></i>
                    <strong>Total Users</strong>
                </div>
                <p class="text-muted mb-0">@Model.Count registered users in the system</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-2">
                    <i data-lucide="shield-check" class="me-2 text-success" style="width: 16px; height: 16px;"></i>
                    <strong>Admin Users</strong>
                </div>
                <p class="text-muted mb-0">@Model.Count(x => x.Roles.Contains("Admin")) administrators</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-2">
                    <i data-lucide="users" class="me-2 text-info" style="width: 16px; height: 16px;"></i>
                    <strong>Active Roles</strong>
                </div>
                <p class="text-muted mb-0">Customer, Engineer, Admin roles available</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions section removed -->
</div>

<script>
// Instant role assignment function (client-side only, no server calls)
function updateRoleDisplay(selectElement, userId) {
    const newRole = selectElement.value;
    const row = selectElement.closest('tr');
    const currentRoleBadge = row.querySelector('.role-badge') || row.querySelector('td:nth-child(2) .text-muted');
    
    // Update the current role badge immediately (no delays or server calls)
    if (currentRoleBadge) {
        if (newRole) {
            const roleClass = getRoleClass(newRole);
            currentRoleBadge.className = `role-badge ${roleClass}`;
            currentRoleBadge.innerHTML = `<i data-lucide="user-check" class="me-1" style="width: 12px; height: 12px;"></i>${newRole}`;
        } else {
            currentRoleBadge.className = 'text-muted';
            currentRoleBadge.innerHTML = 'No role assigned';
        }
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    // Show brief success message
    showTempMessage(`Role updated to ${newRole || 'No Role'}`, 'success');
}

function getRoleClass(role) {
    switch(role) {
        case 'Admin': return 'bg-danger text-white';
        case 'Engineer': return 'bg-warning text-dark';
        case 'Customer': return 'bg-info text-white';
        default: return 'bg-secondary text-white';
    }
}

function deleteUser(userId, userEmail) {
    if (confirm(`Are you sure you want to delete user ${userEmail}? This action cannot be undone.`)) {
        // Remove the row immediately (client-side only)
        const row = document.querySelector(`select[data-user-id="${userId}"]`).closest('tr');
        if (row) {
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';
            setTimeout(() => {
                row.remove();
                showTempMessage(`User ${userEmail} deleted`, 'success');
                
                // Update the total count
                updateUserCount();
            }, 300);
        }
    }
}

function updateUserCount() {
    const totalUsersSpan = document.querySelector('.text-muted').parentElement.querySelector('p');
    if (totalUsersSpan) {
        const currentCount = document.querySelectorAll('tbody tr').length;
        totalUsersSpan.textContent = `${currentCount} registered users in the system`;
    }
}

function showTempMessage(message, type) {
    // Create and show temporary message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 2 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 2000);
}

// Prevent any form submissions from dropdowns
document.addEventListener('DOMContentLoaded', function() {
    // Remove any existing form elements that might cause server calls
    const forms = document.querySelectorAll('form[action*="SetRole"]');
    forms.forEach(form => form.remove());
});
</script>
